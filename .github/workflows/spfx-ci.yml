name: SPFx Stage Promotion Pipeline

on:
  push:
    branches:
      - dev 
      - test
      - prod

jobs:
  build-and-promote:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          npm install
          npm install -g gulp

      # 4️⃣ Build SPFx solution
      - name: Bundle Solution
        run: gulp bundle --ship

      - name: Package Solution
        run: gulp package-solution --ship

      # 5️⃣ Install CLI for Microsoft 365
      - name: Install CLI for M365
        run: npm install -g @pnp/cli-microsoft365

      # 6️⃣ Login using certificate
      - name: Login to Microsoft 365
        run: |
          m365 login --authType certificate \
            --tenant "${{ secrets.TENANT_ID }}" \
            --appId "${{ secrets.CLIENT_ID }}" \
            --certificateBase64Encoded "${{ secrets.CERTIFICATE_BASE64 }}" \
            --password "${{ secrets.CERTIFICATE_PASSWORD }}"

      # 7️⃣ Deploy & Install Based on Branch
      - name: Deploy and Install to Environment
        run: |
          FILE=$(ls sharepoint/solution/*.sppkg)
          PACKAGE_NAME=$(basename "$FILE")

          echo "Package: $PACKAGE_NAME"
          echo "Current Branch: $GITHUB_REF"

          # Upload to Tenant App Catalog
          m365 spo app add \
            --filePath "$FILE" \
            --overwrite

          # Deploy globally
          m365 spo app deploy \
            --name "$PACKAGE_NAME"

          # Decide target site based on branch
          if [[ "${GITHUB_REF}" == "refs/heads/dev" ]]; then
            SITE="https://wb0wj.sharepoint.com/sites/dev"
            echo "Installing to DEV site"
          elif [[ "${GITHUB_REF}" == "refs/heads/test" ]]; then
            SITE="https://wb0wj.sharepoint.com/sites/testing"
            echo "Installing to TEST site"
          elif [[ "${GITHUB_REF}" == "refs/heads/prod" ]]; then
            SITE="https://wb0wj.sharepoint.com/sites/prod"
            echo "Installing to PROD site"
          else
            echo "No matching environment"
            exit 1
          fi

          # Install app to selected site
          m365 spo app install \
            --name "$PACKAGE_NAME" \
            --siteUrl "$SITE"

      # 8️⃣ Logout
      - name: Logout
        run: m365 logout
