name: SPFx CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    # Checkout code
    - name: Checkout repository
      uses: actions/checkout@v3

    # Setup Node 18 (SPFx 1.20 requirement)
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18.x

    # Install dependencies
    - name: Install dependencies
      run: npm install

    # Build SPFx
    - name: Build solution
      run: gulp build --ship

    # Bundle solution
    - name: Bundle solution
      run: gulp bundle --ship

    # Package solution
    - name: Package solution
      run: gulp package-solution --ship

    # Deploy to SharePoint App Catalog
    - name: Deploy to SharePoint App Catalog
      shell: pwsh
      run: |
        Install-Module PnP.PowerShell -Force -Scope CurrentUser

        Connect-PnPOnline `
          -Url "https://wb0wj-admin.sharepoint.com" `
          -ClientId "${{ secrets.CLIENT_ID }}" `
          -ClientSecret "${{ secrets.CLIENT_SECRET }}"

        $sppkgPath = Get-ChildItem -Path "sharepoint/solution" -Filter *.sppkg

        Add-PnPApp `
          -Path $sppkgPath.FullName `
          -Scope Tenant `
          -Publish `
          -Overwrite   
