name: SPFx CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      TENANT_DOMAIN: wb0wj.onmicrosoft.com
      APP_CATALOG_URL: https://wb0wj.sharepoint.com/sites/appcatalog

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # Install dependencies
      - name: Install npm packages
        run: npm ci

      # Build SPFx solution
      - name: Build SPFx solution
        run: |
          gulp bundle --ship
          gulp package-solution --ship

      # Install PnP PowerShell
      - name: Install PnP PowerShell
        shell: pwsh
        run: |
          Install-Module PnP.PowerShell -Force -Scope CurrentUser

      # Deploy to SharePoint App Catalog
      - name: Deploy to SharePoint App Catalog
        shell: pwsh
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: |
          Connect-PnPOnline `
            -Url "$env:APP_CATALOG_URL" `
            -ClientId "$env:CLIENT_ID" `
            -ClientSecret "$env:CLIENT_SECRET" `
            -Tenant "$env:TENANT_DOMAIN"

          Add-PnPApp `
            -Path "sharepoint/solution/hello-word.sppkg" `
            -Overwrite

          Publish-PnPApp `
            -Identity "hello-word.sppkg"

          Write-Host "Deployment completed successfully."
